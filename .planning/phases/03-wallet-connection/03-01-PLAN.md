---
phase: 03-wallet-connection
plan: 01
type: execute
---

<objective>
Set up Cartridge Controller integration with Expo web browser authentication flow.

Purpose: Enable wallet connection in React Native via Cartridge's web-based auth, bridging the gap between Controller's web-first design and mobile.
Output: Working wallet hook with connect/disconnect functions and address retrieval.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-wallet-connection/DISCOVERY.md

# Prior phase context (from frontmatter):
@.planning/phases/02-counter-read/02-01-SUMMARY.md

# Key files:
@src/config/starknet.ts
@App.tsx
@package.json

**Tech stack available:** starknet.js v9, @cartridge/controller ^0.12.1, react-native-get-random-values
**Established patterns:**
- Config in src/config/ with exported functions
- ABI definitions in src/types/
- Polyfill import first in index.ts

**Constraining decisions:**
- Phase 01-02: Use react-native-get-random-values for crypto polyfills
- Phase 02-01: Use starknet.js v9 ContractOptions constructor (object parameter)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Expo packages for web browser auth flow</name>
  <files>package.json</files>
  <action>Install expo-web-browser and expo-linking for handling Cartridge auth redirect flow. These packages work in Expo managed workflow without native code changes.

Run: `npx expo install expo-web-browser expo-linking`

Note: expo-web-browser opens system browser for auth, expo-linking handles deep link callbacks.</action>
  <verify>npm ls expo-web-browser expo-linking shows both packages installed</verify>
  <done>Both packages in package.json dependencies, no errors on install</done>
</task>

<task type="auto">
  <name>Task 2: Create wallet configuration and hook</name>
  <files>src/config/wallet.ts, src/hooks/useWallet.ts</files>
  <action>Create wallet integration module:

**src/config/wallet.ts:**
- Import Controller from @cartridge/controller
- Create controller instance with session policies for counter contract:
  - increase_counter entrypoint
  - decrease_counter entrypoint
- Export controller instance
- Export CONTRACT_ADDRESS constant (reuse from starknet.ts or import)

**src/hooks/useWallet.ts:**
- Create useWallet hook with state: address (string | null), isConnecting (boolean), error (string | null)
- Implement connect() function:
  - Set isConnecting true
  - Call controller.connect()
  - Store account.address in state
  - Handle errors gracefully
- Implement disconnect() function:
  - Call controller.disconnect()
  - Clear address state
- Return { address, isConnecting, error, connect, disconnect, isConnected: !!address }

Important: Controller.connect() returns a starknet.js Account-compatible object. The account.address property contains the wallet address.

Note: Controller uses iframe/popup on web - for React Native this will open in system browser via expo-web-browser if properly configured. Initial implementation may need testing to verify flow works in Expo environment.</action>
  <verify>TypeScript compilation passes (npx tsc --noEmit), no import errors</verify>
  <done>wallet.ts exports controller with policies, useWallet.ts exports hook with connect/disconnect/address</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Cartridge Controller wallet hook with connect/disconnect functionality</what-built>
  <how-to-verify>
    1. Run: npx expo start --ios
    2. Open app in iOS Simulator
    3. Note: At this point there's no UI to trigger connect - verification is that:
       - App builds without errors
       - No runtime crashes on import
    4. Check Metro bundler logs for any module resolution errors
    5. Confirm app still displays counter value (existing functionality intact)
  </how-to-verify>
  <resume-signal>Type "approved" if app runs without errors, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] expo-web-browser and expo-linking installed
- [ ] src/config/wallet.ts exists with controller instance and policies
- [ ] src/hooks/useWallet.ts exists with connect/disconnect/address functionality
- [ ] TypeScript compiles without errors
- [ ] App still runs (existing counter functionality works)
</verification>

<success_criteria>

- All packages installed
- Wallet configuration created with session policies
- useWallet hook implemented with connect/disconnect
- No TypeScript errors
- Existing counter read functionality unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/03-wallet-connection/03-01-SUMMARY.md` following the summary template.
</output>
