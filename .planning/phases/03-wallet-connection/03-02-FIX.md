---
phase: 03-wallet-connection
plan: 03-02-FIX
type: fix
---

<objective>
Fix 1 UAT issue from plan 03-02.

Source: 03-02-ISSUES.md
Priority: 1 blocker, 0 major, 0 minor

**Issue:** Cartridge session callback shows blank page instead of redirecting back to the app after successful login.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/03-wallet-connection/03-02-ISSUES.md

**Original plan for reference:**
@.planning/phases/03-wallet-connection/03-02-PLAN.md

**Current implementation:**
@src/config/wallet.ts
@src/hooks/useWallet.ts
@app.json

**Key insight from logs:**
- Redirect URI: `exp://192.168.1.50:8081/--/session`
- This uses Expo's development server format
- Cartridge's session page may not handle `exp://` protocol redirects properly
- After login succeeds, Cartridge shows blank page instead of redirecting

**Potential causes:**
1. `exp://` protocol not recognized by Cartridge's redirect logic
2. The `preferEphemeralSession: true` option may prevent proper redirect handling
3. Cartridge may require a specific URL format or HTTPS scheme
4. Deep linking configuration may be incomplete
</context>

<tasks>

<task type="auto">
  <name>Task 1: Research Cartridge session callback behavior</name>
  <files>N/A (research only)</files>
  <action>Investigate Cartridge's session callback behavior:

1. Check Cartridge documentation/examples for React Native session flow
2. Review the session URL format and expected callback parameters
3. Understand what redirect_uri formats Cartridge supports

Key questions to answer:
- Does Cartridge support `exp://` protocol redirects?
- What redirect_uri format works with Cartridge in React Native?
- Is there a known issue with Cartridge session redirects?

Check web for:
- Cartridge controller React Native examples
- Cartridge session authorization documentation
- expo-web-browser + custom scheme issues

Document findings before proceeding to fix.</action>
  <verify>Research completed with documented findings</verify>
  <done>Understanding of Cartridge callback behavior and potential fix approaches</done>
</task>

<task type="auto">
  <name>Task 2: Fix redirect URI handling</name>
  <files>src/config/wallet.ts, app.json</files>
  <action>Based on research, implement the fix. Likely approaches:

**Option A: Use custom scheme consistently**
Update `Linking.createURL()` to use the app's custom scheme (`counterapp://`) instead of the development `exp://` format:

```typescript
// Instead of: Linking.createURL('session')
// Use: Linking.createURL('session', { scheme: 'counterapp' })
// Or build manually: 'counterapp://session'
```

**Option B: Remove ephemeral session option**
The `preferEphemeralSession: true` may interfere with redirect handling. Try without it:

```typescript
const result = await WebBrowser.openAuthSessionAsync(sessionUrl, redirectUri);
```

**Option C: Use simpler policy format**
Cartridge may expect policies without the `target` field for session authorization:

```typescript
const policiesJson = policies.map(policy => ({
  method: policy.method,
}));
```

**Option D: Add createSessionCookies option**
Some auth flows need explicit cookie handling:

```typescript
const result = await WebBrowser.openAuthSessionAsync(sessionUrl, redirectUri, {
  createTask: false,
});
```

Choose the approach based on research findings. Test each approach if unclear.

**Important:** After login on Cartridge succeeds, the callback URL should include session data. The blank page indicates the redirect itself is failing, not the parsing.</action>
  <verify>After making changes, test the connection flow:
1. `npx expo start --ios`
2. Tap "Connect Wallet"
3. Login on Cartridge
4. Verify redirect happens (no blank page)
5. Verify address displays in app</verify>
  <done>Wallet connection flow completes successfully - login on Cartridge redirects back to app with session data</done>
</task>

<task type="auto">
  <name>Task 3: Update deep linking configuration if needed</name>
  <files>app.json, potentially App.tsx or entry point</files>
  <action>If the fix requires deep linking changes:

1. Ensure `scheme` is properly configured in app.json (currently "counterapp")
2. Add any required iOS/Android specific configurations
3. If using Expo Router, ensure linking config is correct
4. May need to add `expo-linking` plugin to app.json

For iOS Simulator testing:
- Custom schemes work without additional config
- Expo Go handles `exp://` internally

For standalone builds:
- Custom scheme must match app.json
- May need `npx expo prebuild` to apply changes

Test that deep linking works:
```bash
# From terminal, test deep link
npx uri-scheme open counterapp://session --ios
```

If the scheme itself is working, the issue is likely in how Cartridge handles the redirect.</action>
  <verify>Deep link `counterapp://session` opens the app correctly</verify>
  <done>Deep linking configuration verified and working</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed wallet connection callback - should now redirect from Cartridge back to app</what-built>
  <how-to-verify>
    1. Run: npx expo start --ios
    2. Open app in iOS Simulator
    3. Tap "Connect Wallet"
    4. Login on Cartridge session page
    5. **Critical:** After login, should redirect back to app (no blank page)
    6. Verify connected address displays
    7. Try disconnecting and reconnecting with different account
  </how-to-verify>
  <resume-signal>Type "approved" if wallet connection works end-to-end, or describe remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Cartridge login redirects back to app (no blank page)
- [ ] Session data is received and parsed
- [ ] Address displays correctly after connection
- [ ] Disconnect works
- [ ] Can reconnect after disconnect
- [ ] Phase 4 transaction functionality unaffected
</verification>

<success_criteria>
- UAT-001 resolved: Wallet connection callback works correctly
- User can connect wallet via Cartridge session flow
- Address displays after successful connection
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/03-wallet-connection/03-02-FIX-SUMMARY.md`

Update `.planning/phases/03-wallet-connection/03-02-ISSUES.md`:
- Move UAT-001 to "Resolved Issues" section
- Document the fix applied
</output>
