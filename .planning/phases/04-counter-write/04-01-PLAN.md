---
phase: 04-counter-write
plan: 01
type: execute
---

<objective>
Implement increment and decrement counter transactions with wallet signing.

Purpose: Enable users to modify the counter value via signed blockchain transactions using their connected Cartridge session.
Output: Working increment/decrement buttons that execute signed transactions and update the displayed counter.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase summaries (dependency chain):**
@.planning/phases/03-wallet-connection/03-02-SUMMARY.md

**Key source files:**
@src/config/wallet.ts - Session storage with privateKey, policies for increase/decrease_counter
@src/config/starknet.ts - RpcProvider, CONTRACT_ADDRESS, getCounterContract()
@src/hooks/useWallet.ts - Wallet state with address, connect/disconnect
@src/types/counter.ts - ABI (currently read-only, needs write functions)
@App.tsx - Main UI with counter display and wallet connection

**Tech stack available:**
- starknet.js v9 (Account, Contract, RpcProvider)
- Session-based auth with stored privateKey
- Cartridge policies already configured for increase_counter/decrease_counter

**Established patterns:**
- Contract config in src/config/ with exported functions
- Hooks in src/hooks/ for React state management
- Session data in AsyncStorage with privateKey field

**Constraining decisions from prior phases:**
- Use starknet.js v9 object parameter syntax for constructors
- Session stores privateKey (via ec.starkCurve.utils.randomPrivateKey())
- Cartridge RPC URL: https://api.cartridge.gg/x/starknet/sepolia
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add write function ABIs and transaction execution</name>
  <files>src/types/counter.ts, src/config/starknet.ts</files>
  <action>
1. Extend COUNTER_ABI in src/types/counter.ts to include increase_counter and decrease_counter functions:
   - increase_counter: type "function", inputs [{ name: "amount", type: "core::integer::u128" }], outputs [], state_mutability "external"
   - decrease_counter: type "function", inputs [{ name: "amount", type: "core::integer::u128" }], outputs [], state_mutability "external"

2. Add transaction execution to src/config/starknet.ts:
   - Import Account from starknet
   - Import getStoredSession from ./wallet
   - Create getSessionAccount() async function:
     - Call getStoredSession() to get { address, privateKey }
     - Return null if no session
     - Create and return new Account(provider, address, privateKey) using the existing provider
   - Create executeCounterTransaction(method: 'increase_counter' | 'decrease_counter', amount: bigint = 1n) async function:
     - Get session account, throw if not connected
     - Use account.execute() with { contractAddress: CONTRACT_ADDRESS, entrypoint: method, calldata: [amount.toString()] }
     - Return the transaction hash from result.transaction_hash
     - Note: Cartridge session handles gas/fees automatically
  </action>
  <verify>TypeScript compiles without errors: npx tsc --noEmit</verify>
  <done>
- COUNTER_ABI includes increase_counter and decrease_counter with external state_mutability
- getSessionAccount() returns Account instance from stored session
- executeCounterTransaction() executes transaction and returns hash
  </done>
</task>

<task type="auto">
  <name>Task 2: Add increment/decrement buttons with transaction feedback</name>
  <files>App.tsx</files>
  <action>
1. Import executeCounterTransaction from ./src/config/starknet

2. Add state for transaction:
   - const [txPending, setTxPending] = useState(false)
   - const [txError, setTxError] = useState<string | null>(null)

3. Create handleTransaction async function:
   - Takes method: 'increase_counter' | 'decrease_counter'
   - Set txPending true, txError null
   - try: await executeCounterTransaction(method), then await fetchCounter() to refresh
   - catch: setTxError(message)
   - finally: setTxPending(false)

4. Add UI below the counter value (but above refresh button):
   - Container View with flexDirection: 'row', gap: 20, marginVertical: 20
   - Decrement button (-): TouchableOpacity with onPress={() => handleTransaction('decrease_counter')}
     - Style: 60x60, backgroundColor '#dc3545' (red), borderRadius 30 (circle)
     - Text "-" centered, fontSize 32, color white, fontWeight bold
     - Disabled when !isConnected || txPending || loading
   - Increment button (+): TouchableOpacity with onPress={() => handleTransaction('increase_counter')}
     - Style: 60x60, backgroundColor '#28a745' (green), borderRadius 30 (circle)
     - Text "+" centered, fontSize 32, color white, fontWeight bold
     - Disabled when !isConnected || txPending || loading

5. Show transaction status:
   - If txPending: ActivityIndicator below buttons with text "Transaction pending..."
   - If txError: Text with error message in red

6. Conditional styling:
   - Buttons show opacity 0.4 when disabled
   - Add hint text when !isConnected: "Connect wallet to modify counter"
  </action>
  <verify>
- npm run ios (or expo start) launches app
- When disconnected: buttons appear disabled with hint text
- When connected: buttons are enabled
- Tapping + or - shows "Transaction pending..." and eventually updates counter
  </verify>
  <done>
- Increment (+) and decrement (-) buttons visible below counter
- Buttons disabled when wallet not connected
- Transaction pending state shows loading indicator
- Counter refreshes automatically after successful transaction
- Transaction errors display to user
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes with no TypeScript errors
- [ ] App launches without crashes
- [ ] Buttons are disabled when wallet disconnected
- [ ] Connecting wallet enables the buttons
- [ ] Tapping increment executes transaction and updates counter
- [ ] Tapping decrement executes transaction and updates counter
- [ ] Transaction pending state displays during execution
- [ ] Transaction errors display gracefully
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors or warnings
- Counter increment/decrement works end-to-end via signed transactions
- UI provides clear feedback during transaction lifecycle
  </success_criteria>

<output>
After completion, create `.planning/phases/04-counter-write/04-01-SUMMARY.md` following the summary template.

Update `.planning/STATE.md`:
- Current position: Phase 4 complete
- Progress: 80%

Update `.planning/ROADMAP.md`:
- Mark Phase 4 complete with date
- Update progress table
</output>
